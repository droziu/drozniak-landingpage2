{"version":3,"sources":["../../../../../../strony_www/drozniak-landingpage/app/hooks/useClientPanel.ts","../../../../../../strony_www/drozniak-landingpage/app/panel/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect } from 'react';\nimport { supabase } from '@/lib/supabase-client';\nimport { useAuth } from './useAuth';\n\nexport type ViewTag = 'documents' | 'courses' | 'marketing' | 'data' | 'projects';\n\nexport interface PanelClient {\n  id: string;\n  marketing_client_id: string | null;\n}\n\nexport const useClientPanel = () => {\n  const { user } = useAuth();\n  const [panelClient, setPanelClient] = useState<PanelClient | null>(null);\n  const [viewGrants, setViewGrants] = useState<ViewTag[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    if (!user) {\n      setPanelClient(null);\n      setViewGrants([]);\n      setLoading(false);\n      return;\n    }\n    load();\n  }, [user?.id]);\n\n  const load = async () => {\n    if (!user) return;\n    setLoading(true);\n    try {\n      console.log('useClientPanel: loading for user', user.id, user.email);\n      // Używamy funkcji SECURITY DEFINER zamiast bezpośredniego zapytania - omija RLS\n      const [pcRes, grantsRes] = await Promise.all([\n        supabase.rpc('get_my_panel_client'),\n        supabase.rpc('get_my_view_grants'),\n      ]);\n\n      console.log('useClientPanel: pcRes (from RPC)', pcRes);\n      console.log('useClientPanel: pcRes.data', pcRes.data);\n      console.log('useClientPanel: pcRes.error', pcRes.error);\n      console.log('useClientPanel: grantsRes', grantsRes);\n      console.log('useClientPanel: grantsRes.data', grantsRes.data);\n      console.log('useClientPanel: grantsRes.error', grantsRes.error);\n\n      if (pcRes.error) {\n        console.error('useClientPanel: get_my_panel_client error', pcRes.error);\n        console.error('useClientPanel: error details', JSON.stringify(pcRes.error, null, 2));\n        setPanelClient(null);\n        setViewGrants([]);\n        return;\n      }\n\n      // get_my_panel_client zwraca TABLE, więc data to array\n      const pcData = Array.isArray(pcRes.data) && pcRes.data.length > 0 ? pcRes.data[0] : null;\n      setPanelClient(pcData ? { id: pcData.id, marketing_client_id: pcData.marketing_client_id } : null);\n\n      // Jeśli nie ma panel_clients, nie ma też view_grants\n      if (!pcData) {\n        setViewGrants([]);\n        return;\n      }\n\n      if (grantsRes.error) {\n        console.error('useClientPanel: get_my_view_grants error', grantsRes.error);\n        setViewGrants([]);\n        return;\n      }\n\n      const tags = (Array.isArray(grantsRes.data) ? grantsRes.data : []) as string[];\n      setViewGrants(tags.filter((t): t is ViewTag => ['documents','courses','marketing','data','projects'].includes(t)));\n    } catch (e) {\n      console.error('useClientPanel load error:', e);\n      setPanelClient(null);\n      setViewGrants([]);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return { panelClient, viewGrants, loading, reload: load };\n};\n","'use client';\n\nimport { useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useClientPanel } from '@/app/hooks/useClientPanel';\nimport { LoadingState } from '@/components/LoadingState';\n\nconst TAB: Record<string, { path: string; label: string }> = {\n  documents: { path: 'documents', label: 'Umowy i dokumenty' },\n  courses: { path: 'courses', label: 'Kursy' },\n  marketing: { path: 'marketing', label: 'Marketing' },\n  data: { path: 'data', label: 'Dane' },\n  projects: { path: 'projects', label: 'Projekty' },\n};\n\nconst TAB_ORDER = ['data', 'documents', 'courses', 'marketing', 'projects'];\n\nexport default function PanelRootPage() {\n  const router = useRouter();\n  const { panelClient, viewGrants, loading } = useClientPanel();\n\n  useEffect(() => {\n    if (!loading) {\n      // Jeśli nie ma panelu klienta, przekieruj do widoku z komunikatem\n      if (!panelClient) {\n        // Użyj catch-all route, który obsłuży brak panelu\n        router.replace('/panel/data');\n        return;\n      }\n      \n      // Jeśli nie ma uprawnień, przekieruj do widoku z komunikatem\n      if (viewGrants.length === 0) {\n        router.replace('/panel/data');\n        return;\n      }\n      \n      // Jeśli są uprawnienia, przekieruj do pierwszego dostępnego widoku\n      if (viewGrants.length > 0) {\n        const orderedGrants = TAB_ORDER.filter((t) => viewGrants.includes(t as any));\n        const first = TAB[orderedGrants[0]];\n        if (first) {\n          router.replace(`/panel/${first.path}`);\n        }\n      }\n    }\n  }, [loading, panelClient, viewGrants, router]);\n\n  return <LoadingState variant=\"fullscreen\" label=\"Ładowanie panelu…\" />;\n}\n"],"names":[],"mappings":"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"}